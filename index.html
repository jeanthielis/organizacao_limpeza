<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ControlPoint - Cloud & Hist√≥rico</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --bg-primary: #f0f2f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f9f9f9;
            --bg-card: #ffffff;
            --text-primary: #333333;
            --text-secondary: #555555;
            --accent: #007bff;
            --success: #28a745;
            --danger: #dc3545;
            --border: #dee2e6;
            --shadow: rgba(0, 0, 0, 0.1);
            --modal-overlay: rgba(0, 0, 0, 0.5);
        }

        [data-theme="dark"] {
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --bg-tertiary: #2d2d2d;
            --bg-card: #1e1e1e;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --accent: #4dabf7;
            --success: #40c057;
            --danger: #fa5252;
            --border: #444;
            --shadow: rgba(0, 0, 0, 0.4);
            --modal-overlay: rgba(0, 0, 0, 0.8);
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg-primary); color: var(--text-primary); line-height: 1.6; padding: 10px; transition: 0.3s; }
        .container { max-width: 1300px; margin: 0 auto; }
        
        /* Header & Layout */
        header { background: var(--bg-card); padding: 15px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 4px 12px var(--shadow); display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); }
        .logo { display: flex; gap: 10px; align-items: center; }
        .logo i { font-size: 2rem; color: var(--accent); }
        .main-content { display: flex; gap: 15px; flex-wrap: wrap; }
        .main-column { flex: 1; min-width: 300px; }
        .card { background: var(--bg-card); border-radius: 8px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 12px var(--shadow); border: 1px solid var(--border); position: relative; }
        
        /* Controls */
        button { background: var(--accent); color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-secondary { background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-danger { background: var(--danger); color: white; }
        .icon-btn { background: transparent; color: var(--text-secondary); font-size: 1.2rem; padding: 8px; }
        input, select, textarea { padding: 10px; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 6px; width: 100%; }
        [data-theme="dark"] input[type="date"], [data-theme="dark"] input[type="month"] { color-scheme: dark; }

        /* Checklist */
        .checkpoints-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin: 15px 0; }
        .checkpoint { display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--bg-tertiary); border-radius: 6px; border: 1px solid var(--border); }
        .checkpoint label { flex: 1; cursor: pointer; font-size: 14px; }
        .checkpoint input[type="checkbox"] { width: 20px; height: 20px; accent-color: var(--accent); }
        .note-btn { background: transparent; color: var(--text-secondary); padding: 5px; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; opacity: 0.6; }
        .note-btn:hover { background: rgba(0,0,0,0.1); opacity: 1; color: var(--text-primary); }
        .note-btn.has-note { color: var(--accent); background: rgba(0, 123, 255, 0.1); opacity: 1; }

        /* Progress */
        .progress-bar { height: 25px; background: var(--border); border-radius: 12px; position: relative; overflow: hidden; margin-top: 5px; }
        .progress-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.5s; }
        .progress-fill.danger { background: var(--danger); }
        .progress-text { position: absolute; width: 100%; text-align: center; top: 50%; transform: translateY(-50%); color: white; font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.5); font-size: 12px; }

        /* Teams */
        .team-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .team-btn { padding: 15px; text-align: center; background: var(--bg-tertiary); border: 2px solid transparent; border-radius: 6px; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .team-btn.active { border-color: var(--accent); background: rgba(0, 123, 255, 0.05); }

        /* History List */
        .history-container { margin-top: 20px; border-top: 1px solid var(--border); padding-top: 15px; }
        .history-list { max-height: 250px; overflow-y: auto; display: none; margin-top: 10px; }
        .history-list.show { display: block; }
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border); font-size: 14px; background: var(--bg-tertiary); margin-bottom: 5px; border-radius: 4px; }
        .history-actions { display: flex; gap: 5px; }
        .history-btn { padding: 5px 8px; font-size: 12px; }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-overlay); display: flex; justify-content: center; align-items: center; z-index: 2000; opacity: 0; pointer-events: none; transition: 0.3s; }
        .modal-overlay.open { opacity: 1; pointer-events: all; }
        .modal { background: var(--bg-card); width: 90%; max-width: 600px; border-radius: 8px; display: flex; flex-direction: column; max-height: 90vh; border: 1px solid var(--border); }
        .modal-header, .modal-footer { padding: 15px; background: var(--bg-tertiary); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; overflow-y: auto; }

        /* Misc */
        .chart-container { height: 300px; position: relative; margin: 20px 0; }
        .badge { padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; }
        .badge-success { background: rgba(40, 167, 69, 0.2); color: var(--success); }
        .badge-danger { background: rgba(220, 53, 69, 0.2); color: var(--danger); }
        
        @media print {
            body { background: white; color: black; }
            header, .filters, .report-actions, .logo, .action-bar, .history-container, .team-buttons { display: none !important; }
            .card { box-shadow: none; border: none; }
            .chart-container { height: 400px !important; page-break-inside: avoid; }
        }
        @media (max-width: 768px) { .main-content { flex-direction: column; } .checkpoints-grid { grid-template-columns: 1fr 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-chart-line"></i>
                <div>
                    <h1>ControlPoint</h1>
                    <p style="font-size: 12px; opacity: 0.8;">Gest√£o 4.0</p>
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="icon-btn" id="theme-toggle" title="Modo Escuro"><i class="fas fa-moon"></i></button>
                <button class="icon-btn" id="config-btn" title="Configura√ß√µes"><i class="fas fa-cog"></i></button>
            </div>
        </header>
        
        <div class="main-content">
            <div class="main-column">
                <div class="card">
                    <h3><i class="fas fa-users"></i> Equipe</h3>
                    <div class="team-buttons" id="team-buttons-container"></div>
                </div>
                
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px;">
                        <h3>Checklist: <span id="team-display">...</span></h3>
                        <div class="badge badge-success" id="connection-status" style="display:none; background: var(--success); color: white;">Online</div>
                    </div>
                    
                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:15px;">
                        <input type="date" id="date-input">
                        <button id="today-btn" class="btn-secondary" style="width: auto;">Hoje</button>
                    </div>

                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 0%"></div>
                        <div class="progress-text">0%</div>
                    </div>
                    <div style="display:flex; justify-content:space-between; font-size:12px; margin-top:5px; color:var(--text-secondary);">
                        <span>Meta: <span id="meta-display">93%</span></span>
                        <span id="status-text">...</span>
                    </div>
                    <div style="margin-top:10px;">
                        <input type="range" id="meta-range" min="50" max="100" value="93">
                    </div>

                    <div style="text-align:right; margin: 10px 0;">
                        <button id="toggle-all" class="btn-secondary" style="font-size:12px; padding: 5px 10px;">
                            <i class="fas fa-check-double"></i> Selecionar Todos
                        </button>
                    </div>

                    <div class="checkpoints-grid" id="checklist-container"></div>

                    <button id="save-btn" style="width:100%; margin-top:15px; justify-content:center;">
                        <i class="fas fa-save"></i> SALVAR DADOS
                    </button>

                    <div class="history-container">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h4><i class="fas fa-history"></i> Hist√≥rico da Equipe</h4>
                            <button class="icon-btn" id="toggle-history-btn" style="font-size: 1rem;"><i class="fas fa-chevron-down"></i></button>
                        </div>
                        <div class="history-list" id="history-list">
                            <p style="text-align:center; padding:10px; color:#888;">Carregando hist√≥rico...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="main-column">
                <div class="card">
                    <h3><i class="fas fa-chart-pie"></i> Relat√≥rios & An√°lises</h3>
                    
                    <div style="display:grid; gap:10px; margin-top:15px;">
                        <select id="report-type">
                            <option value="pareto">An√°lise de Causas (Pareto)</option>
                            <option value="daily">Relat√≥rio Di√°rio</option>
                            <option value="monthly">Desempenho Mensal</option>
                            <option value="ranking">Ranking das Equipes</option>
                        </select>
                        
                        <div style="display:flex; gap:10px;">
                            <select id="report-team-filter">
                                <option value="all">Todas as Equipes</option>
                            </select>
                            <input type="month" id="report-month">
                        </div>

                        <button id="generate-btn"><i class="fas fa-search"></i> Gerar Relat√≥rio</button>
                    </div>
                    
                    <div class="report-actions" style="margin-top:10px; display:flex; gap:5px; flex-wrap:wrap;">
                        <button class="btn-secondary" id="print-btn" style="font-size:12px;"><i class="fas fa-print"></i></button>
                        <button class="btn-secondary" id="export-btn" style="font-size:12px;"><i class="fas fa-file-csv"></i> CSV</button>
                        
                        <label for="import-file" class="button btn-secondary" style="font-size:12px; cursor: pointer; display: flex; align-items: center; gap:8px; margin:0;">
                            <i class="fas fa-file-import"></i> Importar CSV
                        </label>
                        <input type="file" id="import-file" accept=".csv" style="display: none;">
                    </div>

                    <div id="report-area" style="margin-top:20px; border-top:1px solid var(--border); padding-top:20px;">
                        <p style="text-align:center; color:var(--text-secondary);">Selecione os filtros e clique em gerar.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="note-modal">
        <div class="modal">
            <div class="modal-header"><h3>Detalhes</h3><button class="icon-btn close-modal"><i class="fas fa-times"></i></button></div>
            <div class="modal-body">
                <h4 id="note-title" style="color:var(--accent); margin-bottom:10px;"></h4>
                <label>Motivo:</label>
                <select id="note-reason" style="margin-bottom:15px;"><option value="">-- Selecione --</option><option value="Manuten√ß√£o">Manuten√ß√£o / Quebra</option><option value="Operacional">Falha Operacional</option><option value="Material">Falta de Material</option><option value="Pessoal">Falta de Pessoal</option><option value="Qualidade">Problema de Qualidade</option><option value="Limpeza">Falta de Limpeza</option><option value="Outros">Outros</option></select>
                <label>Observa√ß√£o:</label><textarea id="note-text" rows="3"></textarea>
            </div>
            <div class="modal-footer"><button class="btn-secondary" id="clear-note">Apagar</button><button id="save-note">Salvar</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="config-modal">
        <div class="modal" style="max-width:800px;">
            <div class="modal-header"><h3>Configura√ß√µes</h3><button class="icon-btn close-modal"><i class="fas fa-times"></i></button></div>
            <div class="modal-body">
                <h4>Equipes</h4><div id="cfg-teams" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;"></div>
                <h4>Pontos</h4><div id="cfg-points" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;"></div>
            </div>
            <div class="modal-footer"><button class="btn-secondary" id="reset-cfg">Restaurar</button><button id="save-cfg">Salvar</button></div>
        </div>
    </div>

    <div id="toast" style="position:fixed; top:20px; right:20px; background:var(--success); color:white; padding:15px; border-radius:6px; transform:translateX(150%); transition:0.3s; z-index:3000;">Salvo com sucesso!</div>

    <script>
        // CONFIGURA√á√ÉO DO FIREBASE (SUAS CHAVES)
        const firebaseConfig = {
            apiKey: "AIzaSyAzkGqL3ezapXtGvSXcwBFiXnrEuAvrnpQ",
            authDomain: "controlpoint-1728a.firebaseapp.com",
            projectId: "controlpoint-1728a",
            storageBucket: "controlpoint-1728a.firebasestorage.app",
            messagingSenderId: "183053800864",
            appId: "1:183053800864:web:ee6124ad66384c25a0c0c5",
            measurementId: "G-WG867BJGKL"
        };

        let db = null;
        let isCloud = false;

        try {
            if (typeof firebaseConfig !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                isCloud = true;
                console.log("ControlPoint: Conectado √† Nuvem ‚òÅÔ∏è");
                setTimeout(() => { document.getElementById('connection-status').style.display = 'block'; }, 1000);
            }
        } catch (e) { console.error("Erro Firebase:", e); }

        // ADAPTADOR DE ARMAZENAMENTO ATUALIZADO (SUPORTE A DELETE E IMPORTA√á√ÉO)
        const Storage = {
            async get(collection, docId) {
                if (isCloud && db) {
                    try {
                        const doc = await db.collection(collection).doc(docId).get();
                        return doc.exists ? doc.data().value : null;
                    } catch(e) { return localStorage.getItem(`${collection}_${docId}`) ? JSON.parse(localStorage.getItem(`${collection}_${docId}`)) : null; }
                } else {
                    const val = localStorage.getItem(`${collection}_${docId}`);
                    return val ? JSON.parse(val) : null;
                }
            },
            async set(collection, docId, data) {
                if (isCloud && db) {
                    try { await db.collection(collection).doc(docId).set({ value: data, updatedAt: new Date(), teamId: data.teamId, date: data.date }); } catch(e) { console.error(e); }
                }
                localStorage.setItem(`${collection}_${docId}`, JSON.stringify(data));
            },
            async remove(collection, docId) {
                if (isCloud && db) {
                    try { await db.collection(collection).doc(docId).delete(); } catch(e) { console.error(e); }
                }
                localStorage.removeItem(`${collection}_${docId}`);
            },
            async listAll(collection) {
                if (isCloud && db && collection === 'records') {
                    // Tenta buscar da nuvem para o hist√≥rico
                    try {
                        const snapshot = await db.collection(collection).get();
                        const cloudDocs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data().value }));
                        return cloudDocs;
                    } catch(e) { 
                        // Fallback local
                        return Object.keys(localStorage).filter(k => k.startsWith(collection)).map(k => JSON.parse(localStorage.getItem(k)));
                    }
                }
                return Object.keys(localStorage).filter(k => k.startsWith(collection)).map(k => JSON.parse(localStorage.getItem(k)));
            }
        };

        const DEFAULT_CONFIG = {
            teams: { 't1': 'Equipe 1', 't2': 'Equipe 2', 't3': 'Equipe 3', 't4': 'Equipe 4' },
            points: [
                'Sala de Tonalidade L4', 'Sala de Padr√µes L4', '√Årea da Qualitron L4', '√Årea de Inspe√ß√£o L4',
                '√Årea de Retido L4', 'Antigo Falcon L4', 'Deforma√ß√£o L4/L5', 'Sala de Tonalidade L5/L6',
                'Sala de Padr√µes L5/L6', '√Årea da Qualitron L5', '√Årea de Inspe√ß√£o L5/L6', '√Årea de Retido L5',
                '√Årea da Qualitrons L6', 'Cavaletes de Empeno', '√Årea de Retido L6', 'Deforma√ß√£o L6'
            ]
        };

        let state = {
            config: JSON.parse(JSON.stringify(DEFAULT_CONFIG)),
            currentTeam: 't1',
            checks: Array(16).fill(false),
            notes: Array(16).fill(null),
            meta: 93
        };

        let chartInstance = null;

        document.addEventListener('DOMContentLoaded', async () => {
            const savedCfg = await Storage.get('settings', 'config');
            if (savedCfg) state.config = savedCfg;
            
            const theme = localStorage.getItem('theme');
            if (theme === 'dark') document.body.setAttribute('data-theme', 'dark');

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date-input').value = today;
            document.getElementById('report-month').value = today.substring(0, 7);
            
            setupUI();
            await loadData();
            refreshHistory();
        });

        function setupUI() {
            renderTeams();
            
            document.getElementById('date-input').addEventListener('change', loadData);
            document.getElementById('today-btn').addEventListener('click', () => {
                document.getElementById('date-input').value = new Date().toISOString().split('T')[0];
                loadData();
            });

            document.getElementById('meta-range').addEventListener('input', (e) => {
                state.meta = e.target.value;
                document.getElementById('meta-display').textContent = state.meta + '%';
                updateProgress();
            });

            document.getElementById('save-btn').addEventListener('click', saveData);

            let allOn = false;
            document.getElementById('toggle-all').addEventListener('click', () => {
                allOn = !allOn;
                state.checks.fill(allOn);
                renderChecklist();
                updateProgress();
            });

            document.getElementById('generate-btn').addEventListener('click', generateReport);
            document.getElementById('print-btn').addEventListener('click', () => window.print());
            document.getElementById('export-btn').addEventListener('click', exportCSV);
            
            // IMPORTAR
            document.getElementById('import-file').addEventListener('change', importCSV);

            document.getElementById('theme-toggle').addEventListener('click', () => {
                const isDark = document.body.getAttribute('data-theme') === 'dark';
                document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
                localStorage.setItem('theme', isDark ? 'light' : 'dark');
            });

            document.getElementById('config-btn').addEventListener('click', openConfig);
            document.getElementById('save-cfg').addEventListener('click', saveConfig);
            document.getElementById('reset-cfg').addEventListener('click', () => { state.config = JSON.parse(JSON.stringify(DEFAULT_CONFIG)); openConfig(); });
            document.querySelectorAll('.close-modal').forEach(b => b.onclick = (e) => e.target.closest('.modal-overlay').classList.remove('open'));

            // HIST√ìRICO TOGGLE
            document.getElementById('toggle-history-btn').addEventListener('click', () => {
                const list = document.getElementById('history-list');
                const btn = document.getElementById('toggle-history-btn');
                if (list.classList.contains('show')) {
                    list.classList.remove('show');
                    btn.innerHTML = '<i class="fas fa-chevron-down"></i>';
                } else {
                    list.classList.add('show');
                    btn.innerHTML = '<i class="fas fa-chevron-up"></i>';
                    refreshHistory();
                }
            });
        }

        function renderTeams() {
            const container = document.getElementById('team-buttons-container');
            const select = document.getElementById('report-team-filter');
            container.innerHTML = '';
            select.innerHTML = '<option value="all">Todas as Equipes</option>';

            Object.keys(state.config.teams).forEach(key => {
                const name = state.config.teams[key];
                const btn = document.createElement('div');
                btn.className = `team-btn ${key === state.currentTeam ? 'active' : ''}`;
                btn.innerHTML = `<i class="fas fa-user-group"></i><span>${name}</span>`;
                btn.onclick = () => { state.currentTeam = key; renderTeams(); loadData(); refreshHistory(); };
                container.appendChild(btn);

                const opt = document.createElement('option');
                opt.value = key;
                opt.text = name;
                select.appendChild(opt);
            });
            document.getElementById('team-display').textContent = state.config.teams[state.currentTeam];
        }

        async function loadData() {
            const date = document.getElementById('date-input').value;
            const docId = `${state.currentTeam}_${date}`;
            
            state.checks.fill(false);
            state.notes.fill(null);

            const data = await Storage.get('records', docId);
            if (data) {
                state.checks = data.checks || state.checks;
                state.notes = data.notes || state.notes;
            }

            renderChecklist();
            updateProgress();
        }

        async function saveData() {
            const date = document.getElementById('date-input').value;
            const docId = `${state.currentTeam}_${date}`;
            const payload = { checks: state.checks, notes: state.notes, teamId: state.currentTeam, date: date };
            const btn = document.getElementById('save-btn');
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
            await Storage.set('records', docId, payload);
            btn.innerHTML = '<i class="fas fa-save"></i> SALVAR DADOS';
            
            showToast();
            refreshHistory();
        }

        // --- L√ìGICA DE HIST√ìRICO (RECUPERADA) ---
        async function refreshHistory() {
            const list = document.getElementById('history-list');
            if (!list.classList.contains('show')) return;
            
            list.innerHTML = '<p style="text-align:center;"><i class="fas fa-spinner fa-spin"></i> Atualizando...</p>';
            
            // Busca todos e filtra localmente (mais simples para "Test Mode")
            const allRecords = await Storage.listAll('records');
            const teamRecords = allRecords.filter(r => r.teamId === state.currentTeam);
            
            // Ordernar por data (Decrescente)
            teamRecords.sort((a,b) => b.date.localeCompare(a.date));

            list.innerHTML = '';
            if (teamRecords.length === 0) {
                list.innerHTML = '<p style="text-align:center; color:#888;">Nenhum registro encontrado.</p>';
                return;
            }

            teamRecords.forEach(r => {
                const pct = ((r.checks.filter(Boolean).length / 16) * 100).toFixed(1);
                const isMeta = pct >= state.meta;
                const dateDisplay = r.date.split('-').reverse().join('/');

                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `
                    <div>
                        <strong>${dateDisplay}</strong>
                        <span class="badge ${isMeta ? 'badge-success' : 'badge-danger'}" style="margin-left:5px;">${pct}%</span>
                    </div>
                    <div class="history-actions">
                        <button class="btn-secondary history-btn" title="Editar" onclick="editDate('${r.date}')"><i class="fas fa-pen"></i></button>
                        <button class="btn-danger history-btn" title="Excluir" onclick="deleteDate('${r.date}')"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        window.editDate = (date) => {
            document.getElementById('date-input').value = date;
            loadData();
            window.scrollTo({ top: 0, behavior: 'smooth' });
            // Se estiver no mobile, fecha o hist√≥rico para ver o editor
            if (window.innerWidth < 768) document.getElementById('history-list').classList.remove('show');
        };

        window.deleteDate = async (date) => {
            if (confirm(`Deseja apagar permanentemente o registro de ${date}?`)) {
                await Storage.remove('records', `${state.currentTeam}_${date}`);
                refreshHistory();
                if (document.getElementById('date-input').value === date) loadData(); // Limpa a tela se estiver vendo o exclu√≠do
                showToast("Registro exclu√≠do.");
            }
        };

        // --- L√ìGICA DE IMPORTA√á√ÉO (RECUPERADA) ---
        function importCSV(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(event) {
                const text = event.target.result;
                const lines = text.split('\n');
                let count = 0;

                // Esperado: Data,Equipe,Pontos_OK,Notas
                // Ignorar cabe√ßalho
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    // Regex para lidar com as aspas das Notas
                    const parts = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
                    const cleanParts = parts.map(p => p.replace(/^"|"$/g, '').replace(/,$/, '')); // Remove aspas e virgulas extras
                    
                    if (cleanParts.length < 3) continue;

                    const date = cleanParts[0]; // YYYY-MM-DD
                    const teamName = cleanParts[1];
                    const pointsOk = parseInt(cleanParts[2]);
                    
                    // Encontrar ID da equipe pelo nome
                    let teamId = Object.keys(state.config.teams).find(k => state.config.teams[k] === teamName);
                    if (!teamId) teamId = 't1'; // Fallback

                    // Recriar objeto
                    const checks = Array(16).fill(false);
                    for (let j = 0; j < pointsOk; j++) checks[j] = true;

                    // Tentar parsear notas se existirem
                    // (Importa√ß√£o b√°sica: recupera a contagem. Notas complexas s√£o dif√≠ceis de parsear de volta do CSV simples, ent√£o deixamos array vazio ou null)
                    const notes = Array(16).fill(null);

                    await Storage.set('records', `${teamId}_${date}`, {
                        checks, notes, teamId, date
                    });
                    count++;
                }

                alert(`${count} registros importados com sucesso!`);
                refreshHistory();
                loadData();
                e.target.value = ''; // Reset input
            };
            reader.readAsText(file);
        }

        function renderChecklist() {
            const div = document.getElementById('checklist-container');
            div.innerHTML = '';
            
            state.config.points.forEach((label, i) => {
                const el = document.createElement('div');
                el.className = 'checkpoint';
                const hasNote = state.notes[i] && (state.notes[i].reason || state.notes[i].text);

                el.innerHTML = `
                    <input type="checkbox" id="chk-${i}" ${state.checks[i] ? 'checked' : ''}>
                    <label for="chk-${i}">${label}</label>
                    <button class="note-btn ${hasNote ? 'has-note' : ''}" onclick="openNote(${i})">
                        <i class="${hasNote ? 'fas fa-comment-dots' : 'far fa-comment'}"></i>
                    </button>
                `;
                el.querySelector('input').onchange = (e) => {
                    state.checks[i] = e.target.checked;
                    updateProgress();
                };
                div.appendChild(el);
            });
        }

        function updateProgress() {
            const total = state.checks.length;
            const checked = state.checks.filter(Boolean).length;
            const pct = (checked / total) * 100;
            const fill = document.querySelector('.progress-fill');
            const text = document.querySelector('.progress-text');
            const status = document.getElementById('status-text');

            fill.style.width = pct + '%';
            text.textContent = pct.toFixed(1) + '%';
            
            if (pct >= state.meta) {
                fill.className = 'progress-fill';
                status.innerHTML = '<span class="badge badge-success">Meta Batida</span>';
            } else {
                fill.className = 'progress-fill danger';
                status.innerHTML = '<span class="badge badge-danger">Abaixo da Meta</span>';
            }
        }

        let currentNoteIdx = -1;
        function openNote(i) {
            currentNoteIdx = i;
            const note = state.notes[i] || { reason: '', text: '' };
            document.getElementById('note-title').textContent = state.config.points[i];
            document.getElementById('note-reason').value = note.reason;
            document.getElementById('note-text').value = note.text;
            document.getElementById('note-modal').classList.add('open');
        }

        document.getElementById('save-note').onclick = () => {
            const reason = document.getElementById('note-reason').value;
            const text = document.getElementById('note-text').value;
            if (reason || text) state.notes[currentNoteIdx] = { reason, text };
            else state.notes[currentNoteIdx] = null;
            document.getElementById('note-modal').classList.remove('open');
            renderChecklist();
        };

        document.getElementById('clear-note').onclick = () => {
            state.notes[currentNoteIdx] = null;
            document.getElementById('note-modal').classList.remove('open');
            renderChecklist();
        };

        function openConfig() {
            const teamDiv = document.getElementById('cfg-teams');
            const pointDiv = document.getElementById('cfg-points');
            teamDiv.innerHTML = ''; pointDiv.innerHTML = '';

            Object.keys(state.config.teams).forEach(k => {
                teamDiv.innerHTML += `<input type="text" data-key="${k}" class="cfg-team-input" value="${state.config.teams[k]}">`;
            });
            state.config.points.forEach((p, i) => {
                pointDiv.innerHTML += `<input type="text" data-idx="${i}" class="cfg-point-input" value="${p}">`;
            });
            document.getElementById('config-modal').classList.add('open');
        }

        async function saveConfig() {
            const teams = {};
            document.querySelectorAll('.cfg-team-input').forEach(el => teams[el.dataset.key] = el.value);
            const points = [];
            document.querySelectorAll('.cfg-point-input').forEach(el => points[el.dataset.idx] = el.value);
            const sortedPoints = Array.from(document.querySelectorAll('.cfg-point-input')).map(e => e.value);

            state.config = { teams, points: sortedPoints };
            await Storage.set('settings', 'config', state.config);
            document.getElementById('config-modal').classList.remove('open');
            setupUI();
        }

        async function generateReport() {
            const type = document.getElementById('report-type').value;
            const teamFilter = document.getElementById('report-team-filter').value;
            const month = document.getElementById('report-month').value;
            const area = document.getElementById('report-area');

            if (!month) { alert('Selecione um m√™s'); return; }

            area.innerHTML = '<div style="text-align:center; padding:20px;"><i class="fas fa-spinner fa-spin fa-2x"></i><p>Buscando dados...</p></div>';

            const rawData = [];
            const allRecords = await Storage.listAll('records');
            
            for (const r of allRecords) {
                if (!r.date.startsWith(month)) continue;
                if (teamFilter !== 'all' && r.teamId !== teamFilter) continue;
                rawData.push(r);
            }

            if (rawData.length === 0) {
                area.innerHTML = '<p style="text-align:center;">Nenhum dado encontrado neste per√≠odo.</p>';
                return;
            }

            if (chartInstance) { chartInstance.destroy(); chartInstance = null; }

            if (type === 'pareto') {
                const causes = {};
                let total = 0;
                rawData.forEach(r => {
                    if (r.notes) {
                        r.notes.forEach(n => {
                            if (n && n.reason) {
                                causes[n.reason] = (causes[n.reason] || 0) + 1;
                                total++;
                            }
                        });
                    }
                });
                const sorted = Object.entries(causes).sort((a,b) => b[1] - a[1]);
                if (total === 0) { area.innerHTML = '<p>Nenhuma falha justificada.</p>'; return; }
                area.innerHTML = `<h4>Causas de Falha (Pareto)</h4><div class="chart-container"><canvas id="chart"></canvas></div>`;
                const ctx = document.getElementById('chart').getContext('2d');
                chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: { labels: sorted.map(x => x[0]), datasets: [{ label: 'Ocorr√™ncias', data: sorted.map(x => x[1]), backgroundColor: '#dc3545' }] },
                    options: { maintainAspectRatio: false }
                });

            } else if (type === 'daily') {
                let html = `<h4>Detalhado Di√°rio</h4>`;
                rawData.sort((a,b) => a.date.localeCompare(b.date));
                rawData.forEach(r => {
                    const ok = r.checks.filter(Boolean).length;
                    const pct = (ok / 16) * 100;
                    html += `<div style="border-bottom:1px solid var(--border); padding:10px 0;">
                        <strong>${r.date.split('-').reverse().join('/')}</strong> - ${state.config.teams[r.teamId]} 
                        <span class="badge ${pct >= 93 ? 'badge-success' : 'badge-danger'}">${pct.toFixed(1)}%</span>
                        <ul style="font-size:12px; color:var(--text-secondary); margin-top:5px; padding-left:20px;">`;
                    r.notes.forEach((n, i) => {
                        if (n && (n.reason || n.text)) {
                            html += `<li><b>${state.config.points[i]}:</b> [${n.reason}] ${n.text}</li>`;
                        }
                    });
                    html += `</ul></div>`;
                });
                area.innerHTML = html;

            } else if (type === 'monthly') {
                const stats = {};
                rawData.forEach(r => {
                    if (!stats[r.teamId]) stats[r.teamId] = { sum: 0, count: 0 };
                    const pct = (r.checks.filter(Boolean).length / 16) * 100;
                    stats[r.teamId].sum += pct;
                    stats[r.teamId].count++;
                });
                const labels = Object.keys(stats).map(k => state.config.teams[k]);
                const data = Object.values(stats).map(v => (v.sum / v.count).toFixed(1));
                area.innerHTML = `<h4>M√©dia Mensal</h4><div class="chart-container"><canvas id="chart"></canvas></div>`;
                const ctx = document.getElementById('chart').getContext('2d');
                chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: { labels: labels, datasets: [{ label: 'M√©dia %', data: data, backgroundColor: '#007bff' }] },
                    options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } } }
                });

            } else if (type === 'ranking') {
                 const stats = {};
                rawData.forEach(r => {
                    if (!stats[r.teamId]) stats[r.teamId] = { sum: 0, count: 0 };
                    const pct = (r.checks.filter(Boolean).length / 16) * 100;
                    stats[r.teamId].sum += pct;
                    stats[r.teamId].count++;
                });
                const list = Object.keys(stats).map(k => ({
                    name: state.config.teams[k],
                    avg: stats[k].sum / stats[k].count
                })).sort((a,b) => b.avg - a.avg);
                let rank = 1;
                list.forEach((item, i) => {
                    if (i > 0 && item.avg < list[i-1].avg) rank++;
                    item.rank = rank;
                });
                let html = `<h4>Ranking do M√™s</h4><table style="width:100%; text-align:left; margin-top:10px;"><tr><th>Pos</th><th>Equipe</th><th>M√©dia</th></tr>`;
                list.forEach((item, i) => {
                    let medal = item.rank===1 ? 'ü•á' : item.rank===2 ? 'ü•à' : item.rank===3 ? 'ü•â' : '';
                    html += `<tr><td>${item.rank}¬∫</td><td>${item.name} ${medal}</td><td>${item.avg.toFixed(1)}%</td></tr>`;
                });
                area.innerHTML = html + '</table>';
            }
        }

        async function exportCSV() {
            const allRecords = await Storage.listAll('records');
            let csv = "Data,Equipe,Pontos_OK,Notas\n";
            for (const r of allRecords) {
                const ok = r.checks.filter(Boolean).length;
                const notes = r.notes.filter(n => n && n.reason).map(n => n.reason).join(' | ');
                csv += `${r.date},${state.config.teams[r.teamId]},${ok},"${notes}"\n`;
            }
            const blob = new Blob([csv], {type:'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'dados_controlpoint.csv';
            a.click();
        }

        function showToast(msg = "Salvo com sucesso!") {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.transform = 'translateX(0)';
            setTimeout(() => t.style.transform = 'translateX(150%)', 3000);
        }
    </script>
</body>
</html>