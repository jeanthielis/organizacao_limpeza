<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ControlPoint - Relat√≥rios Avan√ßados</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --bg-primary: #f0f2f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f9f9f9;
            --bg-card: #ffffff;
            --text-primary: #333333;
            --text-secondary: #555555;
            --accent: #007bff;
            --success: #28a745;
            --danger: #dc3545;
            --border: #dee2e6;
            --shadow: rgba(0, 0, 0, 0.1);
            --modal-overlay: rgba(0, 0, 0, 0.5);
        }

        [data-theme="dark"] {
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --bg-tertiary: #2d2d2d;
            --bg-card: #1e1e1e;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --accent: #4dabf7;
            --success: #40c057;
            --danger: #fa5252;
            --border: #444;
            --shadow: rgba(0, 0, 0, 0.4);
            --modal-overlay: rgba(0, 0, 0, 0.8);
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg-primary); color: var(--text-primary); line-height: 1.6; padding: 10px; transition: 0.3s; }
        .container { max-width: 1300px; margin: 0 auto; }
        
        /* Layout */
        header { background: var(--bg-card); padding: 15px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 4px 12px var(--shadow); display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); }
        .logo { display: flex; gap: 10px; align-items: center; }
        .logo i { font-size: 2rem; color: var(--accent); }
        .main-content { display: flex; gap: 15px; flex-wrap: wrap; }
        .main-column { flex: 1; min-width: 300px; }
        .card { background: var(--bg-card); border-radius: 8px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 12px var(--shadow); border: 1px solid var(--border); position: relative; }
        
        /* UI Elements */
        button { background: var(--accent); color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-secondary { background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-danger { background: var(--danger); color: white; }
        .icon-btn { background: transparent; color: var(--text-secondary); font-size: 1.2rem; padding: 8px; }
        
        input, select, textarea { padding: 10px; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 6px; width: 100%; }
        [data-theme="dark"] input[type="date"], [data-theme="dark"] input[type="month"], [data-theme="dark"] input[type="number"] { color-scheme: dark; }

        /* Checklist */
        .checkpoints-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin: 15px 0; }
        .checkpoint { display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--bg-tertiary); border-radius: 6px; border: 1px solid var(--border); }
        .checkpoint label { flex: 1; cursor: pointer; font-size: 14px; }
        .checkpoint input[type="checkbox"] { width: 20px; height: 20px; accent-color: var(--accent); }
        .note-btn { background: transparent; color: var(--text-secondary); padding: 5px; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; opacity: 0.6; }
        .note-btn.has-note { color: var(--accent); background: rgba(0, 123, 255, 0.1); opacity: 1; }

        /* Progress */
        .progress-bar { height: 25px; background: var(--border); border-radius: 12px; position: relative; overflow: hidden; margin-top: 5px; }
        .progress-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.5s; }
        .progress-fill.danger { background: var(--danger); }
        .progress-text { position: absolute; width: 100%; text-align: center; top: 50%; transform: translateY(-50%); color: white; font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.5); font-size: 12px; }

        /* Teams */
        .team-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .team-btn { padding: 15px; text-align: center; background: var(--bg-tertiary); border: 2px solid transparent; border-radius: 6px; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .team-btn.active { border-color: var(--accent); background: rgba(0, 123, 255, 0.05); }

        /* History */
        .history-container { margin-top: 20px; border-top: 1px solid var(--border); padding-top: 15px; }
        .history-list { max-height: 250px; overflow-y: auto; display: none; margin-top: 10px; }
        .history-list.show { display: block; }
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border); font-size: 14px; background: var(--bg-tertiary); margin-bottom: 5px; border-radius: 4px; }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-overlay); display: flex; justify-content: center; align-items: center; z-index: 2000; opacity: 0; pointer-events: none; transition: 0.3s; }
        .modal-overlay.open { opacity: 1; pointer-events: all; }
        .modal { background: var(--bg-card); width: 90%; max-width: 600px; border-radius: 8px; display: flex; flex-direction: column; max-height: 90vh; border: 1px solid var(--border); }
        .modal-header, .modal-footer { padding: 15px; background: var(--bg-tertiary); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; overflow-y: auto; }

        /* Charts & Reports */
        .chart-container { height: 350px; position: relative; margin: 20px 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid var(--border); font-size: 14px; }
        th { background: var(--bg-tertiary); font-weight: 600; }
        .badge { padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; }
        .badge-success { background: rgba(40, 167, 69, 0.2); color: var(--success); }
        .badge-danger { background: rgba(220, 53, 69, 0.2); color: var(--danger); }
        
        @media print {
            body { background: white; color: black; }
            header, .filters, .report-actions, .logo, .action-bar, .history-container, .team-buttons { display: none !important; }
            .card { box-shadow: none; border: none; }
            .chart-container { height: 400px !important; page-break-inside: avoid; }
        }
        @media (max-width: 768px) { .main-content { flex-direction: column; } .checkpoints-grid { grid-template-columns: 1fr 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-chart-line"></i>
                <div>
                    <h1>ControlPoint</h1>
                    <p style="font-size: 12px; opacity: 0.8;">Gest√£o 4.0</p>
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="icon-btn" id="theme-toggle" title="Modo Escuro"><i class="fas fa-moon"></i></button>
                <button class="icon-btn" id="config-btn" title="Configura√ß√µes"><i class="fas fa-cog"></i></button>
            </div>
        </header>
        
        <div class="main-content">
            <div class="main-column">
                <div class="card">
                    <h3><i class="fas fa-users"></i> Equipe</h3>
                    <div class="team-buttons" id="team-buttons-container"></div>
                </div>
                
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px;">
                        <h3>Checklist: <span id="team-display">...</span></h3>
                        <div class="badge badge-success" id="connection-status" style="display:none; background: var(--success); color: white;">Online</div>
                    </div>
                    
                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:15px;">
                        <input type="date" id="date-input">
                        <button id="today-btn" class="btn-secondary" style="width: auto;">Hoje</button>
                    </div>

                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 0%"></div>
                        <div class="progress-text">0%</div>
                    </div>
                    <div style="display:flex; justify-content:space-between; font-size:12px; margin-top:5px; color:var(--text-secondary);">
                        <span>Meta: <span id="meta-display">93%</span></span>
                        <span id="status-text">...</span>
                    </div>
                    <div style="margin-top:10px;">
                        <input type="range" id="meta-range" min="50" max="100" value="93">
                    </div>

                    <div style="text-align:right; margin: 10px 0;">
                        <button id="toggle-all" class="btn-secondary" style="font-size:12px; padding: 5px 10px;">
                            <i class="fas fa-check-double"></i> Selecionar Todos
                        </button>
                    </div>

                    <div class="checkpoints-grid" id="checklist-container"></div>

                    <button id="save-btn" style="width:100%; margin-top:15px; justify-content:center;">
                        <i class="fas fa-save"></i> SALVAR DADOS
                    </button>

                    <div class="history-container">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h4><i class="fas fa-history"></i> Hist√≥rico</h4>
                            <button class="icon-btn" id="toggle-history-btn" style="font-size: 1rem;"><i class="fas fa-chevron-down"></i></button>
                        </div>
                        <div class="history-list" id="history-list"></div>
                    </div>
                </div>
            </div>

            <div class="main-column">
                <div class="card">
                    <h3><i class="fas fa-chart-pie"></i> Relat√≥rios</h3>
                    
                    <div style="display:grid; gap:10px; margin-top:15px;">
                        <select id="report-type">
                            <option value="daily">Relat√≥rio Di√°rio</option>
                            <option value="monthly">Mensal (Gr√°fico + Ranking)</option>
                            <option value="yearly">Anual (Gr√°fico + Ranking)</option>
                            <option value="pareto">An√°lise de Causas (Pareto)</option>
                        </select>
                        
                        <div style="display:flex; gap:10px;">
                            <select id="report-team-filter">
                                <option value="all">Todas as Equipes</option>
                                </select>

                            <input type="date" id="report-date" style="display:none;">
                            <input type="month" id="report-month" style="display:none;">
                            <input type="number" id="report-year" placeholder="Ano" min="2020" max="2030" style="display:none;">
                        </div>

                        <button id="generate-btn"><i class="fas fa-search"></i> Gerar Relat√≥rio</button>
                    </div>
                    
                    <div class="report-actions" style="margin-top:10px; display:flex; gap:5px; flex-wrap:wrap;">
                        <button class="btn-secondary" id="print-btn" style="font-size:12px;"><i class="fas fa-print"></i></button>
                        <button class="btn-secondary" id="export-btn" style="font-size:12px;"><i class="fas fa-file-csv"></i> CSV</button>
                        <label for="import-file" class="button btn-secondary" style="font-size:12px; cursor: pointer; display: flex; align-items: center; gap:8px; margin:0;">
                            <i class="fas fa-file-import"></i> Importar CSV
                        </label>
                        <input type="file" id="import-file" accept=".csv" style="display: none;">
                    </div>

                    <div id="report-area" style="margin-top:20px; border-top:1px solid var(--border); padding-top:20px;">
                        <p style="text-align:center; color:var(--text-secondary);">Selecione os filtros e clique em gerar.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="note-modal">
        <div class="modal">
            <div class="modal-header"><h3>Detalhes</h3><button class="icon-btn close-modal"><i class="fas fa-times"></i></button></div>
            <div class="modal-body">
                <h4 id="note-title" style="color:var(--accent); margin-bottom:10px;"></h4>
                <label>Motivo:</label>
                <select id="note-reason" style="margin-bottom:15px;"><option value="">-- Selecione --</option><option value="Manuten√ß√£o">Manuten√ß√£o / Quebra</option><option value="Operacional">Falha Operacional</option><option value="Material">Falta de Material</option><option value="Pessoal">Falta de Pessoal</option><option value="Qualidade">Problema de Qualidade</option><option value="Limpeza">Falta de Limpeza</option><option value="Outros">Outros</option></select>
                <label>Observa√ß√£o:</label><textarea id="note-text" rows="3"></textarea>
            </div>
            <div class="modal-footer"><button class="btn-secondary" id="clear-note">Apagar</button><button id="save-note">Salvar</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="config-modal">
        <div class="modal" style="max-width:800px;">
            <div class="modal-header"><h3>Configura√ß√µes</h3><button class="icon-btn close-modal"><i class="fas fa-times"></i></button></div>
            <div class="modal-body">
                <h4>Equipes</h4><div id="cfg-teams" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;"></div>
                <h4>Pontos</h4><div id="cfg-points" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;"></div>
            </div>
            <div class="modal-footer"><button class="btn-secondary" id="reset-cfg">Restaurar</button><button id="save-cfg">Salvar</button></div>
        </div>
    </div>

    <div id="toast" style="position:fixed; top:20px; right:20px; background:var(--success); color:white; padding:15px; border-radius:6px; transform:translateX(150%); transition:0.3s; z-index:3000;">Salvo com sucesso!</div>

    <script>
        // CONFIGURA√á√ÉO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyAzkGqL3ezapXtGvSXcwBFiXnrEuAvrnpQ",
            authDomain: "controlpoint-1728a.firebaseapp.com",
            projectId: "controlpoint-1728a",
            storageBucket: "controlpoint-1728a.firebasestorage.app",
            messagingSenderId: "183053800864",
            appId: "1:183053800864:web:ee6124ad66384c25a0c0c5",
            measurementId: "G-WG867BJGKL"
        };

        let db = null;
        let isCloud = false;

        try {
            if (typeof firebaseConfig !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                isCloud = true;
                console.log("Conectado √† Nuvem");
                setTimeout(() => { document.getElementById('connection-status').style.display = 'block'; }, 1000);
            }
        } catch (e) { console.error("Erro Firebase:", e); }

        const Storage = {
            async get(col, id) {
                if (isCloud && db) {
                    try { const d = await db.collection(col).doc(id).get(); return d.exists ? d.data().value : null; } 
                    catch(e) { return JSON.parse(localStorage.getItem(`${col}_${id}`)); }
                }
                return JSON.parse(localStorage.getItem(`${col}_${id}`));
            },
            async set(col, id, val) {
                if (isCloud && db) try { await db.collection(col).doc(id).set({ value: val, teamId: val.teamId, date: val.date }); } catch(e){}
                localStorage.setItem(`${col}_${id}`, JSON.stringify(val));
            },
            async remove(col, id) {
                if (isCloud && db) try { await db.collection(col).doc(id).delete(); } catch(e){}
                localStorage.removeItem(`${col}_${id}`);
            },
            async listAll(col) {
                if (isCloud && db && col === 'records') {
                    try {
                        const snap = await db.collection(col).get();
                        return snap.docs.map(doc => doc.data().value);
                    } catch(e) { return Object.keys(localStorage).filter(k=>k.startsWith(col)).map(k=>JSON.parse(localStorage.getItem(k))); }
                }
                return Object.keys(localStorage).filter(k=>k.startsWith(col)).map(k=>JSON.parse(localStorage.getItem(k)));
            }
        };

        // DADOS PADR√ÉO
        const DEFAULT_CONFIG = {
            teams: { 't1': 'Equipe 1', 't2': 'Equipe 2', 't3': 'Equipe 3', 't4': 'Equipe 4' },
            points: [
                'Sala de Tonalidade L4', 'Sala de Padr√µes L4', '√Årea da Qualitron L4', '√Årea de Inspe√ß√£o L4',
                '√Årea de Retido L4', 'Antigo Falcon L4', 'Deforma√ß√£o L4/L5', 'Sala de Tonalidade L5/L6',
                'Sala de Padr√µes L5/L6', '√Årea da Qualitron L5', '√Årea de Inspe√ß√£o L5/L6', '√Årea de Retido L5',
                '√Årea da Qualitrons L6', 'Cavaletes de Empeno', '√Årea de Retido L6', 'Deforma√ß√£o L6'
            ]
        };

        let state = {
            config: JSON.parse(JSON.stringify(DEFAULT_CONFIG)),
            currentTeam: 't1',
            checks: Array(16).fill(false),
            notes: Array(16).fill(null),
            meta: 93
        };

        let chartInstance = null;

        // --- PLUGIN PARA DESENHAR LINHA DA META ---
        const metaLinePlugin = {
            id: 'metaLine',
            afterDatasetsDraw(chart, args, options) {
                const { ctx, chartArea: { left, right }, scales: { y } } = chart;
                const metaValue = options.metaValue;
                const yPixel = y.getPixelForValue(metaValue);
                
                ctx.save();
                ctx.beginPath();
                ctx.lineWidth = 2;
                ctx.strokeStyle = '#000000'; // Cor da linha (preta)
                ctx.setLineDash([5, 5]); // Pontilhada
                ctx.moveTo(left, yPixel);
                ctx.lineTo(right, yPixel);
                ctx.stroke();
                
                // Texto da Meta
                ctx.fillStyle = '#000000';
                ctx.textAlign = 'right';
                ctx.fillText(`Meta: ${metaValue}%`, right, yPixel - 5);
                ctx.restore();
            }
        };

        document.addEventListener('DOMContentLoaded', async () => {
            const savedCfg = await Storage.get('settings', 'config');
            if (savedCfg) state.config = savedCfg;
            
            const theme = localStorage.getItem('theme');
            if (theme === 'dark') document.body.setAttribute('data-theme', 'dark');

            const today = new Date();
            document.getElementById('date-input').value = today.toISOString().split('T')[0];
            
            // Inicializar inputs de relat√≥rio
            document.getElementById('report-date').value = today.toISOString().split('T')[0];
            document.getElementById('report-month').value = today.toISOString().substring(0, 7);
            document.getElementById('report-year').value = today.getFullYear();

            setupUI();
            await loadData();
            refreshHistory();
        });

        function setupUI() {
            renderTeams();
            
            // Controle de visualiza√ß√£o de inputs de data baseado no tipo de relat√≥rio
            const reportType = document.getElementById('report-type');
            const toggleInputs = () => {
                const val = reportType.value;
                document.getElementById('report-date').style.display = val === 'daily' ? 'block' : 'none';
                document.getElementById('report-month').style.display = (val === 'monthly' || val === 'pareto') ? 'block' : 'none';
                document.getElementById('report-year').style.display = val === 'yearly' ? 'block' : 'none';
                
                // Filtro de equipe s√≥ faz sentido se n√£o for comparativo (Daily e Pareto precisam, Monthly/Yearly comparam todas)
                // Mas o usu√°rio pode querer ver s√≥ uma no mensal. Vamos deixar.
            };
            reportType.addEventListener('change', toggleInputs);
            toggleInputs(); // Init

            // Inputs principais
            document.getElementById('date-input').addEventListener('change', loadData);
            document.getElementById('today-btn').addEventListener('click', () => {
                document.getElementById('date-input').value = new Date().toISOString().split('T')[0];
                loadData();
            });

            document.getElementById('meta-range').addEventListener('input', (e) => {
                state.meta = e.target.value;
                document.getElementById('meta-display').textContent = state.meta + '%';
                updateProgress();
            });

            document.getElementById('save-btn').addEventListener('click', saveData);
            document.getElementById('toggle-all').addEventListener('click', toggleAllChecks);
            document.getElementById('generate-btn').addEventListener('click', generateReport);
            document.getElementById('print-btn').addEventListener('click', () => window.print());
            document.getElementById('export-btn').addEventListener('click', exportCSV);
            document.getElementById('import-file').addEventListener('change', importCSV);
            document.getElementById('toggle-history-btn').addEventListener('click', toggleHistory);

            document.getElementById('theme-toggle').addEventListener('click', () => {
                const isDark = document.body.getAttribute('data-theme') === 'dark';
                document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
                localStorage.setItem('theme', isDark ? 'light' : 'dark');
            });

            document.getElementById('config-btn').addEventListener('click', openConfig);
            document.getElementById('save-cfg').addEventListener('click', saveConfig);
            document.getElementById('reset-cfg').addEventListener('click', () => { state.config = JSON.parse(JSON.stringify(DEFAULT_CONFIG)); openConfig(); });
            document.querySelectorAll('.close-modal').forEach(b => b.onclick = (e) => e.target.closest('.modal-overlay').classList.remove('open'));
        }

        let allOn = false;
        function toggleAllChecks() {
            allOn = !allOn;
            state.checks.fill(allOn);
            renderChecklist();
            updateProgress();
        }

        function renderTeams() {
            const container = document.getElementById('team-buttons-container');
            const select = document.getElementById('report-team-filter');
            container.innerHTML = '';
            select.innerHTML = '<option value="all">Todas as Equipes</option>';

            Object.keys(state.config.teams).forEach(key => {
                const name = state.config.teams[key];
                const btn = document.createElement('div');
                btn.className = `team-btn ${key === state.currentTeam ? 'active' : ''}`;
                btn.innerHTML = `<i class="fas fa-user-group"></i><span>${name}</span>`;
                btn.onclick = () => { state.currentTeam = key; renderTeams(); loadData(); refreshHistory(); };
                container.appendChild(btn);

                const opt = document.createElement('option');
                opt.value = key;
                opt.text = name;
                select.appendChild(opt);
            });
            document.getElementById('team-display').textContent = state.config.teams[state.currentTeam];
        }

        async function loadData() {
            const date = document.getElementById('date-input').value;
            const docId = `${state.currentTeam}_${date}`;
            state.checks.fill(false);
            state.notes.fill(null);
            const data = await Storage.get('records', docId);
            if (data) { state.checks = data.checks || state.checks; state.notes = data.notes || state.notes; }
            renderChecklist();
            updateProgress();
        }

        async function saveData() {
            const date = document.getElementById('date-input').value;
            const docId = `${state.currentTeam}_${date}`;
            const btn = document.getElementById('save-btn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
            await Storage.set('records', docId, { checks: state.checks, notes: state.notes, teamId: state.currentTeam, date: date });
            btn.innerHTML = '<i class="fas fa-save"></i> SALVAR DADOS';
            showToast();
            refreshHistory();
        }

        function renderChecklist() {
            const div = document.getElementById('checklist-container');
            div.innerHTML = '';
            state.config.points.forEach((label, i) => {
                const el = document.createElement('div');
                el.className = 'checkpoint';
                const hasNote = state.notes[i] && (state.notes[i].reason || state.notes[i].text);
                el.innerHTML = `<input type="checkbox" id="chk-${i}" ${state.checks[i] ? 'checked' : ''}><label for="chk-${i}">${label}</label><button class="note-btn ${hasNote ? 'has-note' : ''}" onclick="openNote(${i})"><i class="${hasNote ? 'fas fa-comment-dots' : 'far fa-comment'}"></i></button>`;
                el.querySelector('input').onchange = (e) => { state.checks[i] = e.target.checked; updateProgress(); };
                div.appendChild(el);
            });
        }

        function updateProgress() {
            const pct = (state.checks.filter(Boolean).length / 16) * 100;
            const fill = document.querySelector('.progress-fill');
            document.querySelector('.progress-text').textContent = pct.toFixed(1) + '%';
            fill.style.width = pct + '%';
            if (pct >= state.meta) { fill.className = 'progress-fill'; document.getElementById('status-text').innerHTML = '<span class="badge badge-success">Meta Batida</span>'; }
            else { fill.className = 'progress-fill danger'; document.getElementById('status-text').innerHTML = '<span class="badge badge-danger">Abaixo da Meta</span>'; }
        }

        // RELAT√ìRIOS
        async function generateReport() {
            const type = document.getElementById('report-type').value;
            const area = document.getElementById('report-area');
            const meta = parseInt(state.meta);
            
            area.innerHTML = '<div style="text-align:center; padding:20px;"><i class="fas fa-spinner fa-spin fa-2x"></i><p>Processando...</p></div>';
            
            const allRecords = await Storage.listAll('records');
            if (chartInstance) { chartInstance.destroy(); chartInstance = null; }

            // L√≥gica Unificada para Mensal e Anual
            if (type === 'monthly' || type === 'yearly') {
                const monthInput = document.getElementById('report-month').value;
                const yearInput = document.getElementById('report-year').value;
                const periodFilter = type === 'monthly' ? monthInput : yearInput;
                const periodLabel = type === 'monthly' ? `Mensal (${monthInput})` : `Anual (${yearInput})`;

                if (!periodFilter) { area.innerHTML = '<p>Selecione o per√≠odo correto.</p>'; return; }

                // Agrupar dados
                const stats = {};
                // Inicializa todas as equipes
                Object.keys(state.config.teams).forEach(tid => stats[tid] = { sum: 0, count: 0 });

                allRecords.forEach(r => {
                    // Filtro de data: Mensal (YYYY-MM) ou Anual (YYYY)
                    if (!r.date.startsWith(periodFilter)) return;
                    
                    if (!stats[r.teamId]) stats[r.teamId] = { sum: 0, count: 0 }; // Seguran√ßa
                    const pct = (r.checks.filter(Boolean).length / 16) * 100;
                    stats[r.teamId].sum += pct;
                    stats[r.teamId].count++;
                });

                // Preparar dados para o Gr√°fico e Tabela
                const labels = [];
                const values = [];
                const colors = [];
                const tableData = [];

                Object.keys(stats).forEach(tid => {
                    const avg = stats[tid].count > 0 ? (stats[tid].sum / stats[tid].count) : 0;
                    const name = state.config.teams[tid];
                    
                    // Dados Gr√°fico
                    labels.push(name);
                    values.push(avg);
                    // Regra de Cor: Verde se >= Meta, Vermelho se < Meta
                    colors.push(avg >= meta ? '#28a745' : '#dc3545');

                    // Dados Tabela
                    tableData.push({ name, avg, count: stats[tid].count });
                });

                // Ordenar Tabela por Ranking
                tableData.sort((a,b) => b.avg - a.avg);
                // Ranking Denso
                let rank = 1;
                tableData.forEach((item, i) => {
                    if (i > 0 && item.avg < tableData[i-1].avg) rank++;
                    item.rank = rank;
                });

                // Renderizar HTML Combinado
                let html = `<h3>Relat√≥rio ${periodLabel}</h3>`;
                
                // 1. Gr√°fico
                html += `<div class="chart-container"><canvas id="mainChart"></canvas></div>`;
                
                // 2. Tabela
                html += `<h4>Ranking Detalhado</h4>
                         <table>
                            <tr><th>Pos</th><th>Equipe</th><th>M√©dia</th><th>Registros</th><th>Status</th></tr>`;
                
                tableData.forEach(item => {
                    const medal = item.rank===1 ? 'ü•á' : item.rank===2 ? 'ü•à' : item.rank===3 ? 'ü•â' : '';
                    const statusClass = item.avg >= meta ? 'badge-success' : 'badge-danger';
                    const statusText = item.avg >= meta ? 'Meta Batida' : 'Abaixo da Meta';
                    
                    html += `<tr>
                        <td>${item.rank}¬∫</td>
                        <td>${item.name} ${medal}</td>
                        <td>${item.avg.toFixed(1)}%</td>
                        <td>${item.count}</td>
                        <td><span class="badge ${statusClass}">${statusText}</span></td>
                    </tr>`;
                });
                html += `</table>`;

                area.innerHTML = html;

                // Renderizar Gr√°fico
                const ctx = document.getElementById('mainChart').getContext('2d');
                chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'M√©dia (%)',
                            data: values,
                            backgroundColor: colors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, max: 100 } },
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                anchor: 'end', align: 'top',
                                formatter: (val) => val.toFixed(1) + '%',
                                font: { weight: 'bold' }
                            },
                            metaLine: { metaValue: meta } // Passar a meta para o plugin customizado
                        }
                    },
                    plugins: [metaLinePlugin] // Ativar o plugin
                });

            } else if (type === 'daily') {
                const dateFilter = document.getElementById('report-date').value;
                const teamFilter = document.getElementById('report-team-filter').value;
                
                let html = `<h4>Relat√≥rio Di√°rio - ${dateFilter.split('-').reverse().join('/')}</h4>`;
                let found = false;

                // Ordenar por equipe
                const sortedRecords = allRecords.filter(r => r.date === dateFilter).sort((a,b) => a.teamId.localeCompare(b.teamId));

                sortedRecords.forEach(r => {
                    if (teamFilter !== 'all' && r.teamId !== teamFilter) return;
                    found = true;
                    
                    const ok = r.checks.filter(Boolean).length;
                    const pct = (ok / 16) * 100;
                    const statusClass = pct >= meta ? 'badge-success' : 'badge-danger';
                    
                    html += `<div style="border:1px solid var(--border); border-radius:8px; padding:15px; margin-bottom:15px; background:var(--bg-tertiary);">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <h4 style="margin:0;">${state.config.teams[r.teamId]}</h4>
                            <span class="badge ${statusClass}">${pct.toFixed(1)}%</span>
                        </div>
                        <ul style="font-size:13px; padding-left:20px; color:var(--text-secondary);">`;
                    
                    // Listar pontos com falha ou notas
                    r.notes.forEach((n, i) => {
                        const isChecked = r.checks[i];
                        if (!isChecked || (n && (n.reason || n.text))) {
                            const icon = isChecked ? '<i class="fas fa-check" style="color:var(--success)"></i>' : '<i class="fas fa-times" style="color:var(--danger)"></i>';
                            const noteTxt = n ? ` <span style="color:var(--text-primary);">[${n.reason || ''}] ${n.text || ''}</span>` : '';
                            html += `<li style="margin-bottom:4px;">${icon} <b>${state.config.points[i]}</b>${noteTxt}</li>`;
                        }
                    });
                    
                    html += `</ul></div>`;
                });

                if (!found) html += '<p>Nenhum registro para esta data.</p>';
                area.innerHTML = html;

            } else if (type === 'pareto') {
                // Pareto simples
                const month = document.getElementById('report-month').value;
                if (!month) { area.innerHTML = '<p>Selecione um m√™s.</p>'; return; }
                const causes = {};
                let total = 0;
                allRecords.forEach(r => {
                    if (r.date.startsWith(month) && r.notes) {
                        r.notes.forEach(n => {
                            if (n && n.reason) { causes[n.reason] = (causes[n.reason] || 0) + 1; total++; }
                        });
                    }
                });
                
                if (total === 0) { area.innerHTML = '<p>Nenhuma falha justificada neste m√™s.</p>'; return; }
                
                const sorted = Object.entries(causes).sort((a,b) => b[1] - a[1]);
                area.innerHTML = `<h4>Causas de Falha (${month})</h4><div class="chart-container"><canvas id="paretoChart"></canvas></div>`;
                
                const ctx = document.getElementById('paretoChart').getContext('2d');
                chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: { labels: sorted.map(x=>x[0]), datasets: [{ label: 'Qtd', data: sorted.map(x=>x[1]), backgroundColor: '#dc3545' }] },
                    options: { maintainAspectRatio: false }
                });
            }
        }

        // --- HIST√ìRICO & CSV ---
        function toggleHistory() {
            const list = document.getElementById('history-list');
            const btn = document.getElementById('toggle-history-btn');
            if (list.classList.contains('show')) { list.classList.remove('show'); btn.innerHTML = '<i class="fas fa-chevron-down"></i>'; }
            else { list.classList.add('show'); btn.innerHTML = '<i class="fas fa-chevron-up"></i>'; refreshHistory(); }
        }

        async function refreshHistory() {
            const list = document.getElementById('history-list');
            if (!list.classList.contains('show')) return;
            list.innerHTML = '<p>Carregando...</p>';
            const all = await Storage.listAll('records');
            const filtered = all.filter(r => r.teamId === state.currentTeam).sort((a,b) => b.date.localeCompare(a.date));
            list.innerHTML = '';
            if (filtered.length === 0) { list.innerHTML = '<p>Vazio.</p>'; return; }
            filtered.forEach(r => {
                const pct = ((r.checks.filter(Boolean).length / 16) * 100).toFixed(1);
                list.innerHTML += `<div class="history-item"><div><strong>${r.date.split('-').reverse().join('/')}</strong> <span class="badge ${pct>=state.meta?'badge-success':'badge-danger'}">${pct}%</span></div><div class="history-actions"><button class="btn-secondary" onclick="editDate('${r.date}')"><i class="fas fa-pen"></i></button><button class="btn-danger" onclick="deleteDate('${r.date}')"><i class="fas fa-trash"></i></button></div></div>`;
            });
        }
        window.editDate = (d) => { document.getElementById('date-input').value = d; loadData(); window.scrollTo(0,0); };
        window.deleteDate = async (d) => { if(confirm('Apagar?')) { await Storage.remove('records', `${state.currentTeam}_${d}`); refreshHistory(); if(document.getElementById('date-input').value===d) loadData(); }};

        async function exportCSV() {
            const all = await Storage.listAll('records');
            let csv = "Data,Equipe,Pontos_OK,Notas\n";
            for (const r of all) {
                const ok = r.checks.filter(Boolean).length;
                const notes = r.notes.filter(n=>n&&n.reason).map(n=>n.reason).join(' | ');
                csv += `${r.date},${state.config.teams[r.teamId]},${ok},"${notes}"\n`;
            }
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
            a.download = 'dados.csv';
            a.click();
        }

        function importCSV(e) {
            const f = e.target.files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = async function(evt) {
                const lines = evt.target.result.split('\n');
                let count = 0;
                for(let i=1; i<lines.length; i++) {
                    const l = lines[i].trim();
                    if(!l) continue;
                    const p = l.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
                    const c = p.map(s=>s.replace(/^"|"$/g,'').replace(/,$/,''));
                    if(c.length<3) continue;
                    const date = c[0];
                    const tName = c[1];
                    const pts = parseInt(c[2]);
                    let tid = Object.keys(state.config.teams).find(k=>state.config.teams[k]===tName) || 't1';
                    const checks = Array(16).fill(false);
                    for(let j=0; j<pts; j++) checks[j]=true;
                    await Storage.set('records', `${tid}_${date}`, { checks, notes: Array(16).fill(null), teamId: tid, date });
                    count++;
                }
                alert(`${count} importados.`);
                refreshHistory();
            };
            r.readAsText(f);
        }

        // NOTES
        let curNote = -1;
        window.openNote = (i) => { curNote=i; const n = state.notes[i] || {reason:'', text:''}; document.getElementById('note-title').textContent = state.config.points[i]; document.getElementById('note-reason').value = n.reason; document.getElementById('note-text').value = n.text; document.getElementById('note-modal').classList.add('open'); };
        document.getElementById('save-note').onclick = () => { const r=document.getElementById('note-reason').value; const t=document.getElementById('note-text').value; state.notes[curNote] = (r||t) ? {reason:r, text:t} : null; document.getElementById('note-modal').classList.remove('open'); renderChecklist(); };
        document.getElementById('clear-note').onclick = () => { state.notes[curNote] = null; document.getElementById('note-modal').classList.remove('open'); renderChecklist(); };

        // CONFIG
        function openConfig() {
            const td=document.getElementById('cfg-teams'); const pd=document.getElementById('cfg-points'); td.innerHTML=''; pd.innerHTML='';
            Object.keys(state.config.teams).forEach(k=>td.innerHTML+=`<input data-k="${k}" class="cfg-t" value="${state.config.teams[k]}">`);
            state.config.points.forEach((p,i)=>pd.innerHTML+=`<input data-i="${i}" class="cfg-p" value="${p}">`);
            document.getElementById('config-modal').classList.add('open');
        }
        async function saveConfig() {
            const teams={}; document.querySelectorAll('.cfg-t').forEach(e=>teams[e.dataset.k]=e.value);
            const points=Array.from(document.querySelectorAll('.cfg-p')).map(e=>e.value);
            state.config={teams,points}; await Storage.set('settings', 'config', state.config);
            document.getElementById('config-modal').classList.remove('open');
            renderTeams(); loadData();
        }

        function showToast() { const t = document.getElementById('toast'); t.style.transform='translateX(0)'; setTimeout(()=>t.style.transform='translateX(150%)', 3000); }
    </script>
</body>
</html>